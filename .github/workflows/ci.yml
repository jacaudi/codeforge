name: CI

on:
  push:
    branches: [main]

permissions:
  contents: write
  packages: write
  issues: write
  pull-requests: write
  security-events: write

jobs:
  lint:
    uses: jacaudi/github-actions/.github/workflows/lint.yml@main
    with:
      shell: true
      shellcheck-paths: '.'

  build:
    needs: [lint]
    uses: jacaudi/github-actions/.github/workflows/docker-build.yml@main

  scan:
    needs: [build]
    uses: jacaudi/github-actions/.github/workflows/image-scan.yml@main
    with:
      image-ref: ${{ needs.build.outputs.image-ref }}
      severity: CRITICAL,HIGH
      exit-code: 0

  validate:
    needs: [build]
    uses: jacaudi/github-actions/.github/workflows/image-validate.yml@main
    with:
      image-ref: ${{ needs.build.outputs.image-ref }}
      command: |
        claude --version &&
        nvim --version | head -1 &&
        git --version &&
        zsh --version &&
        curl --version | head -1 &&
        gh --version | head -1 &&
        glab --version &&
        yq --version &&
        jq --version &&
        chezmoi --version &&
        tmux -V &&
        screen --version &&
        nightshift --version &&
        td --version &&
        id coder &&
        getent passwd coder | grep zsh &&
        grep 'PubkeyAuthentication yes' /etc/ssh/sshd_config &&
        grep 'PasswordAuthentication no' /etc/ssh/sshd_config &&
        grep 'PermitRootLogin no' /etc/ssh/sshd_config &&
        grep 'AllowUsers coder' /etc/ssh/sshd_config &&
        grep 'PrintMotd no' /etc/ssh/sshd_config

  release:
    needs: [scan, validate]
    uses: jacaudi/github-actions/.github/workflows/semantic-release.yml@main
    with:
      allow-initial-development-versions: true
      use-github-app: true
    secrets:
      app-id: ${{ secrets.APP_ID }}
      app-private-key: ${{ secrets.APP_PRIVATE_KEY }}
