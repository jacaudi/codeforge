name: PR

on:
  pull_request:
    branches: [main]

permissions:
  contents: read
  packages: write
  security-events: write

jobs:
  lint:
    uses: jacaudi/github-actions/.github/workflows/lint.yml@main
    with:
      shell: true
      shellcheck-paths: '.'

  build:
    needs: [lint]
    uses: jacaudi/github-actions/.github/workflows/docker-build.yml@main

  scan:
    needs: [build]
    uses: jacaudi/github-actions/.github/workflows/image-scan.yml@main
    with:
      image-ref: ${{ needs.build.outputs.image-ref }}
      severity: CRITICAL,HIGH
      exit-code: 0

  validate:
    needs: [build]
    uses: jacaudi/github-actions/.github/workflows/image-validate.yml@main
    with:
      image-ref: ${{ needs.build.outputs.image-ref }}
      command: |
        claude --version &&
        nvim --version | head -1 &&
        git --version &&
        zsh --version &&
        curl --version | head -1 &&
        gh --version | head -1 &&
        glab --version &&
        yq --version &&
        jq --version &&
        chezmoi --version &&
        id dev &&
        getent passwd dev | grep zsh &&
        grep 'PubkeyAuthentication yes' /etc/ssh/sshd_config &&
        grep 'PasswordAuthentication no' /etc/ssh/sshd_config &&
        grep 'PermitRootLogin no' /etc/ssh/sshd_config &&
        grep 'AllowUsers dev' /etc/ssh/sshd_config
